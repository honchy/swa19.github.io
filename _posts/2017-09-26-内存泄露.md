---
layout: post
title: "内存泄露"
date: 2017-09-26 09:07:03 +0800
tags: java
---

# 问题介绍
最近做项目，遇到了内存溢出的问题：java.lang.OutOfMemoryError: PermGen space，并且调整jvm的MaxPermSize到512M之后错误依旧，由于是在别人的工程中写的新代码，怀疑是别人的工程代码的问题。找人看过后，被告知别人的代码没有问题，但在我的机器上却一直报outofmemory错误，没办法只能自己解决了。
首先明确下PermGen space用来存放什么信息，PermGen space其实指的就是方法区。不过方法区和“PermGen space”又有着本质的区别。前者是 JVM 的规范，而后者则是 JVM 规范的一种实现，并且只有 HotSpot 才有 “PermGen space”，而对于其他类型的虚拟机，如 JRockit（Oracle）、J9（IBM） 并没有“PermGen space”。由于方法区主要存储类的相关信息，所以对于动态生成类的情况比较容易出现永久代的内存溢出用来存放类相关的信息。在编译时，类加载器从class文件中，提取出类的相关信息，并存储在方法区中。
在实例化一个类的对象时，jvm将会从方法区中获取这个类的相关信息，并完成初始化工作。方法区的内存也是可以进行回收的，当某个类不再被使用时，jvm将卸载这个类，进行垃圾回收  
## 解决方法
当出现PermSpace空间OutOfMemory的错误时，可以通过调整jvm方法区的内存大小来尝试初步解决问题：
和方法区相关的jvm参数有两个，-XX:PermSize和-XX:MaxPermSize
如果使用tomcat启动服务，可以修改Tomcat的配置文件catalina.sh文件，添加配置：`JAVA_OPTS="$JAVA_OPTS -Xms512m -Xmx1024m -XX:PermSize=256M -XX:MaxPermSize=512m"`
## 问题排查
当出现内存溢出，很大概率说明代码还是存在问题的，需要排查是哪部分代码引起的溢出问题
* 通过java命令行查看
看永久代的内存使用情况  
`jstat -gcpermcapactity <pid> `
>当使用jdk6启动项目时，报的异常信息为PermGen space不足。但是在jdk8中，原有的PermGen space已经被metaspace内存空间所取代，相应的jstat命令也不再存在`-gcpermcapactity`的选项,取而代之的是`-gcmetacapacity`,这个不再详细写了，具体参考：![永久代(PermGen)和元空间(Metaspace)](http://www.cnblogs.com/paddix/p/5309550.html)
>jstat是一个很强大的用来查看jvm参数的工具，它利用JVM内建的指令对Java应用程序的资源和性能进行实时的命令行的监控。其他jdk自带的工具还有 jstack, jconsole, jinfo, jmap, jdb，后边可以再详细写一个总结。
查看内存空间的分配情况  
`jmap -histo <pid>`  

* 以上是通过java命令行来查看内存使用情况，除此之外，还有其他商业软件来进行监测，我下了Optimizeit试了下，但是使用还有点问题，稍后再补充：

* 另外，java在bin目录下自带了性能监控工具：jvisualvm，刚刚试用了下，相当好用。等后边到公司用1.6的jdk试下这个工具。  

# 常见的引起内存泄露的情况
内存泄露的产生是因为申请的内存空间一直得不到释放，最终导致无法分配更多的内存空间。jvm有自己的内存回收的机制，当一个对象不存在指向它的引用时，这个对象所在的内存空间会被标记，在某种条件下，对这个对象的内存进行回收。  
那么当一个对象已经不再使用，但它的引用依旧被其他对象持有的时候就容易发生内存泄露。  


# 参考：
![jstat](http://docs.oracle.com/javase/8/docs/technotes/tools/unix/jstat.html)
![jmap](http://docs.oracle.com/javase/8/docs/technotes/tools/unix/jmap.html#CEGCECJB)